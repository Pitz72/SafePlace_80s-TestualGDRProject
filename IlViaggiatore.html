<!DOCTYPE html>
<html lang="it" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Safe Place - Prototipo GDR (V14 - Final)</title>
    <style>
        /* --- CSS Completo e Verificato --- */
        :root {
            --bg-color: #000000; --fg-color: #00FF00; --fg-dim-color: #009900;
            --border-color: #00FF00; --border-dim-color: #005500;
            --highlight-bg: #00FF00; --highlight-fg: #000000;
            --accent-color: #FFFF00; --danger-color: #FF4444;
            --overlay-bg: rgba(0, 10, 0, 0.97);
            --plains-color: #00BB00; --forest-color: #008800; --mountain-color: #339933;
            --water-color: #008888; --ruin-color: #55AA55; --special-color: #AAAA00;
            --end-color: var(--accent-color);
        }
        html { height: 100%; }
        body { background-color: var(--bg-color); color: var(--fg-color); font-family: 'Courier New', Courier, monospace; font-size: 16px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; height: 100%; box-sizing: border-box; overflow: hidden; }
        /* Splash, End Screen */
        #splash-screen, #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--fg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; }
        #end-screen { z-index: 99; display: none; } /* Nascosto */
        #end-message { white-space: pre-wrap; max-height: 80%; overflow-y: auto; margin-bottom: 20px; font-size: 1.1em; line-height: 1.4; text-align: left; /* Allinea testo finale a sinistra */ padding: 0 10%; } /* Aggiunge padding orizzontale */
        #end-screen h2 { color: var(--accent-color); margin-bottom: 30px; }
        #end-screen button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.1em; cursor: pointer; margin-top: 20px;}
        #splash-screen h1 { font-size: 2.5em; margin-bottom: 15px; text-shadow: 0 0 5px var(--fg-color); }
        #splash-screen p.subtitle { font-size: 1.1em; margin-bottom: 20px; font-style: italic; opacity: 0.9; }
        #splash-screen p.attribution { font-size: 0.9em; margin-top: 20px; margin-bottom: 30px; opacity: 0.8; }
        @keyframes buttonBlink { 0%, 100% { background-color: #111; color: var(--fg-color); border-color: var(--border-color); box-shadow: 0 0 8px var(--fg-color); } 50% { background-color: var(--highlight-bg); color: var(--highlight-fg); border-color: var(--border-color); box-shadow: 0 0 15px var(--fg-color); } }
        #splash-screen button { background-color: #111; color: var(--fg-color); border: 2px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 8px var(--fg-color); animation: buttonBlink 1.3s step-end infinite; }
        /* --- Aggiunta Stile Intro Screen --- */
        #intro-screen { display: none; /* Nascosto inizialmente */ position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--fg-color); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 98; padding: 30px; box-sizing: border-box; }
        #intro-screen h2 { color: var(--accent-color); margin-bottom: 25px; }
        #intro-text { white-space: pre-wrap; max-height: 70%; overflow-y: auto; margin-bottom: 25px; font-size: 1.0em; line-height: 1.5; text-align: left; max-width: 800px; }
        #intro-screen button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.1em; cursor: pointer; margin-top: 15px; }
        /* --- Fine Stile Intro Screen --- */
        /* Game Container e Sezioni con TAG SEMANTICI */
        main#game-container { display: none; flex-direction: row; border: 2px solid var(--border-color); padding: 10px; box-sizing: border-box; position: relative; width: 100%; height: 100%; max-width: 1000px; max-height: 700px; background-color: var(--bg-color); overflow: hidden; }
        section#map-area { flex: 3; border-right: 1px dashed var(--border-color); padding-right: 10px; margin-right: 10px; display: flex; flex-direction: column; overflow: hidden; }
        #map-display { font-family: 'Courier New', Courier, monospace; white-space: pre; font-size: 18px; line-height: 1.1; margin-bottom: 10px; flex-grow: 1; overflow: auto; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; box-sizing: border-box; }
        /* Stili Colore Mappa */
        .tile-plains { color: var(--plains-color); } .tile-forest { color: var(--forest-color); } .tile-mountain { color: var(--mountain-color); } .tile-river { color: var(--water-color); } .tile-city, .tile-village { color: var(--ruin-color); } .tile-rest-stop, .tile-start { color: var(--special-color); } .tile-end { color: var(--end-color); font-weight: bold; }
        .visited { opacity: 0.6 !important; }
        .player-marker { animation: blink 1s step-end infinite; } @keyframes blink {0%,100%{background-color:var(--highlight-bg);color:var(--highlight-fg);}50%{background-color:transparent;color:var(--fg-color);}}
        #controls { text-align: center; margin-top: 5px; flex-shrink: 0; }
        #controls button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 5px 10px; margin: 2px; font-family: inherit; font-size: 14px; cursor: pointer; }
        #controls button:disabled { color: var(--border-dim-color); border-color: var(--border-dim-color); cursor: not-allowed; }
        section#status-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 220px; }
        #character-stats, #map-legend { margin-bottom: 15px; flex-shrink: 0; }
        #character-stats h3, #map-legend h3, #message-log h3 { margin-top: 0; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); padding-bottom: 3px; flex-shrink: 0; font-size: 1em; }
        #character-stats ul, #map-legend ul { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        #character-stats li, #map-legend li { margin-bottom: 2px; white-space: nowrap; }
        #stat-food, #stat-water { font-weight: bold; } .low-resource { color: var(--danger-color); }
        #map-legend .legend-symbol { display: inline-block; width: 1.5em; text-align: center; font-weight: bold; }
        #message-log { border-top: 1px dashed var(--border-color); padding-top: 5px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; margin-top: 5px; min-height: 100px; }
        #messages { list-style: none; padding: 0; margin: 0; } #messages li { font-size: 0.9em; margin-bottom: 4px; word-break: break-word; } .log-warning { color: var(--danger-color); font-weight: bold;}
        /* Event Overlay */
         #event-overlay { display: none; position: absolute; top: 5%; left: 5%; width: 90%; height: 85%; background-color: var(--overlay-bg); border: 3px solid var(--border-color); color: var(--fg-color); z-index: 50; padding: 15px; box-sizing: border-box; font-size: 1em; overflow-y: auto; text-align: center; }
         #event-overlay h4 { margin-top: 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em; }
         #event-content { margin-bottom: 15px; text-align: left; white-space: pre-wrap; font-size: 0.95em; }
         .danger-text { color: var(--danger-color); font-weight: bold; }
         .event-choice { margin-top: 15px; text-align: center; } /* Centra i pulsanti */
         .event-choice button {
            background-color: #111;
            color: var(--fg-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            margin: 5px;
            display: inline-block; /* O block se li vuoi uno sotto l'altro */
            min-width: 150px; /* Larghezza minima per facilitare tocco */
         }
         .event-choice button:hover {
             background-color: var(--border-dim-color);
         }
         #event-overlay button.continue-button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 8px 15px; font-family: inherit; font-size: 0.9em; cursor: pointer; margin-top: 10px; }
        .hidden { display: none !important; }
        /* Media Query Mobile */
        @media (max-width: 700px) { body{align-items:stretch;} main#game-container{flex-direction:column; max-width:100%; max-height:none; height:100%; padding:5px; border:none;} section#map-area{flex:1 1 55%; border-right:none; border-bottom:1px dashed var(--border-color); padding-right:0; margin-right:0; margin-bottom:10px;} #map-display{font-size:14px; line-height:1.0;} #controls{order:1; margin-bottom:10px;} section#status-area{flex:1 1 45%; min-width:unset; width:100%; order:2;} #map-legend{display:none;} #message-log{font-size:0.85em;} #event-overlay{width:95%; left:2.5%; height:90%; top:2.5%; font-size:0.9em;} #splash-screen h1{font-size:2em;} #splash-screen p.subtitle{font-size:1em;} /* Rimosso stile intro */ }
    </style>
</head>
<body style="height: 100%;">

    <div id="splash-screen"><h1>THE SAFE PLACE</h1><p class="subtitle">Un sussurro di speranza tra le rovine...</p><p class="attribution">un'idea di Simone Pizzi</p><button onclick="startGame()">Inizia il Viaggio</button></div>
    <!-- --- Aggiunta Intro Screen --- -->
    <div id="intro-screen">
        <h2>Prologo</h2>
        <div id="intro-text">
Il mondo come lo conoscevi non esiste più. Le città sono tombe silenziose, le strade sentieri interrotti verso il nulla.
Sei l'Ultimo, o almeno così ti chiamano i pochi disperati che incroci. La tua esistenza è una lotta costante per le risorse più basilari: cibo, acqua, un riparo dal vento gelido che spira tra le rovine.

Ma un giorno, tra i rottami di un vecchio terminale, hai trovato un messaggio frammentato. Parlava di un "Safe Place", un rifugio leggendario dove la civiltà resiste ancora, nascosto da qualche parte in questo mondo devastato.
Senza altra speranza a cui aggrapparti, hai deciso di intraprendere il viaggio.

Il cammino sarà lungo e pericoloso. Dovrai attraversare pianure desolate spazzate dal vento, foreste oscure dove si annidano creature mutate, montagne impervie che graffiano il cielo e le rovine infestate di città cadute.
Le tue scorte sono limitate. La fame e la sete saranno compagne costanti. Predoni senza scrupoli e bestie selvagge potrebbero sbarrarti la strada ad ogni passo.

Riuscirai a gestire le tue risorse, a superare gli ostacoli e a trovare la tua destinazione incerta?
Il tuo viaggio inizia ora. Buona fortuna, Ultimo.
        </div>
        <button onclick="proceedToGame()">Inizia</button>
    </div>
    <!-- --- Fine Intro Screen --- -->
    <!-- Rimosso Intro Overlay -->
    <div id="end-screen"> <h2 id="end-title">...</h2><div id="end-message">...</div><button onclick="window.location.reload()">Ricomincia il Viaggio</button> </div>

    <!-- Contenuto Principale -->
    <main id="game-container">
        <section id="map-area">
            <pre id="map-display">Attendere...</pre>
            <div id="controls"><button onclick="movePlayer(0, -1)" id="btn-up">Nord</button><br/><button onclick="movePlayer(-1, 0)" id="btn-left">Ovest</button><button onclick="movePlayer(1, 0)" id="btn-right">Est</button><br/><button onclick="movePlayer(0, 1)" id="btn-down">Sud</button></div>
        </section>
        <section id="status-area">
             <div id="character-stats"><h3>ULTIMO</h3><ul id="stats-list">
    <li>HP:<span id="stat-hp">--</span>/<span id="stat-maxhp">--</span></li>
    <li>Vigore:<span id="stat-vig">--</span></li>
    <li>Potenza:<span id="stat-pot">--</span></li>
    <li>Agilita':<span id="stat-agi">--</span></li>
    <li>Tracce:<span id="stat-tra">--</span></li>
    <li>Influenza:<span id="stat-inf">--</span></li>
    <li>Presagio:<span id="stat-pre">--</span></li>
    <li>Adattamento:<span id="stat-ada">--</span></li>
    <li>Acquisita:<span id="stat-acq">--</span></li>
    <li>Cibo:<span id="stat-food">--</span></li>
    <li>Acqua:<span id="stat-water">--</span></li>
    <li>Posizione:(<span id="pos-x">--</span>,<span id="pos-y">--</span>)</li>
    <li>Terreno:<span id="tile-type">--</span></li>
    <li id="stat-day-time-li">Tempo:<span id="stat-day-time">--</span></li> <!-- Aggiunto elemento per tempo rimanente -->
</ul></div>
             <div id="map-legend"><h3>LEGENDA</h3><ul id="legend-list"></ul></div>
             <div id="message-log"><ul id="messages"></ul><h3>LOG EVENTI</h3></div>
        </section>
        <div id="event-overlay"><h4 id="event-title">...</h4><div id="event-content">...</div><button onclick="hideEventScreen()" class="continue-button">Continua...</button></div>
    </main>

    <!-- Lo script andrà nel prossimo blocco -->
    <script>
        // Il codice JavaScript verrà fornito nel prossimo messaggio
// --- CONFIGURAZIONE E COSTANTI ---
const MAP_WIDTH=50; const MAP_HEIGHT=30; const MAX_MESSAGES=30;
const CONSUMPTION_RATE=10; const STARTING_FOOD=7; const STARTING_WATER=7; // Modificato da 6 a 7
const TILE_SYMBOLS = { PLAINS:'.', MOUNTAIN:'M', RIVER:'~', FOREST:'F', VILLAGE:'V', CITY:'C', REST_STOP:'R', START:'S', END:'E', PLAYER:'@' };
const TILE_DESC = { '.':'Pianura desolata', 'M':'Montagne cicatrizzate', '~':'Fiume lento', 'F':'Foresta opprimente', 'V':'Accampamento isolato', 'C':'Rovine di città', 'R':'Rifugio improvvisato', 'S':"Punto d'inizio", 'E':'Destinazione incerta', '@':'Ultimo (Tu)' }; // Corretto apice in Punto d'inizio
const DAY_LENGTH_MOVES = 18; // Numero di passi per la fase diurna
const NIGHT_FOOD_COST = 2; // Cibo consumato al mattino dopo notte sicura
const NIGHT_WATER_COST = 2; // Acqua consumata al mattino dopo notte sicura
const HUNGER_PENALTY_HP = 1; // HP persi per fame (prima era 1)
const THIRST_PENALTY_HP = 1; // HP persi per sete (prima era 1)

// --- Testi Variabili (Ampliati e Aggiunti) ---
// Flavor Texts Ambientali
const flavorTextsPlains = ["Il vento solleva polvere.", "Un silenzio innaturale.", "Ossa sbiancate dal sole.", "Una carcassa di animale non identificabile giace lontana.", "Il cielo è vasto e indifferente.", "Piccoli arbusti secchi si aggrappano alla vita."];
const flavorTextsForest = ["Rami secchi scricchiolano sotto i piedi.", "Un odore pungente di decomposizione nell'aria.", "Il silenzio è rotto solo dal tuo respiro.", "Intravedi un movimento fugace tra gli alberi... o è solo la tua immaginazione?", "Strani simboli sono incisi sulla corteccia di un albero antico.", "La luce filtra a fatica tra le fitte chiome."];
const flavorTextsMountain = ["Un'eco lontana risuona tra le vette.", "Il sentiero è ripido e traditore.", "Un'aquila solitaria volteggia alta nel cielo.", "Senti il rumore di piccole pietre che rotolano in basso.", "La carcassa congelata di uno scalatore sfortunato.", "Il vento fischia tra le rocce aguzze."];
const flavorTextsRiver = ["Detriti e rifiuti galleggiano lenti sull'acqua torbida.", "La riva fangosa rende difficile camminare.", "Un pesce morto galleggia a pancia in su.", "Il suono dell'acqua che scorre è quasi ipnotico.", "Resti di un vecchio ponte crollato."];
const flavorTextsCity = ["Il vento geme tra gli scheletri dei grattacieli.", "Un vecchio manifesto strappato sventola da un muro.", "Carcasse arrugginite di automobili bloccano la strada.", "Un silenzio spettrale avvolge tutto.", "Resti di una bambola di porcellana, con un occhio mancante, tra le macerie.", "Un monitor rotto mostra ancora un'immagine statica."];
const flavorTextsVillage = ["Tende strappate sbattono al vento.", "Un fuoco da campo spento da tempo.", "Oggetti personali sparsi qua e là, abbandonati in fretta.", "Nessun segno di vita recente.", "Un silenzio pesante grava sull'accampamento."];
const flavorTextsRestStop = ["Un riparo precario fatto di lamiere e teli.", "Qualcuno ha lasciato segni qui, ma se n'è andato.", "Puzza di vecchio fumo e umidità.", "Sembra relativamente sicuro, per ora."];

// Nuovo: Flavor Texts Notturni (Opzionale, si possono aggiungere)
const flavorTextsNightPlains = ["Un silenzio innaturale avvolge la pianura.", "La luna proietta ombre lunghe e distorte.", "Il vento notturno sussurra strane melodie.", "Senti un fruscio vicino, ma non vedi nulla."];
const flavorTextsNightForest = ["Ogni scricchiolio ti fa sobbalzare.", "Forme indistinte sembrano muoversi tra gli alberi.", "Un odore metallico nell'aria fredda della notte.", "Il buio della foresta è quasi totale."];

// Lore Fragments (Ampliato)
const loreFragments = [
    "Pagina strappata di diario: '... giorno 47. Le scorte sono finite. Ho sentito di un posto sicuro a est, oltre le montagne spezzate. È la mia ultima speranza...'",
    "Pezzo di metallo inciso: 'Progetto Chimera - Proprietà della Volta 7'",
    "Ologramma tremolante da un dispositivo rotto: '...protocollo di contenimento fallito. Evacuare immediatamente...'",
    "Scheda dati danneggiata: '...mutazione instabile... aggressività elevata... eliminare a vista...'",
    "Scarpa da bambino logora accanto a una piccola croce fatta di rametti.",
    "Graffito su un muro: 'Non fidatevi dell'acqua che brilla.'",
    "Registrazione audio disturbata: '...stanno arrivando... non riesco a fermarli... dite a mia figlia che... *statica*'",
    "Mappa disegnata a mano su un pezzo di pelle: Indica un percorso verso un luogo chiamato \'L\'Oasi\', ma è strappata a metà.", // Corretto escaping apici
    "Messaggio inciso su una capsula di proiettile: 'Per Mamma.'",
    "Libro bruciacchiato con una sola pagina leggibile: '...e così gli Antichi Dei dormirono, lasciando il mondo al silenzio...'"
];

// Testi Eventi (Ampliati e Nuovi)
const descrizioniPredoni = ["Ombre si muovono ai margini della tua vista.", "Figure emergono dalla polvere.", "Un fischio acuto rompe il silenzio.", "Un gruppo malmesso ti circonda.", "Hanno occhi affamati e armi improvvisate."];
const vociPredoni = ["'Fermi lì, bello!'", "'Cosa abbiamo qui? Carne fresca!'", "'Non fare movimenti bruschi.'", "'Svuota le tasche, piano piano.'", "'Il pedaggio per passare di qui.'"];
const esitiFugaPredoniOk = ["Scompari nell'ombra prima che possano reagire.", "Li distrai con un lancio di pietre e scappi.", "Trovi una via di fuga inaspettata tra le rovine.", "La tua agilità ti permette di seminarli."];
const esitiFugaPredoniKo = ["Inciampi e cadi, sei alla loro mercé!", "Esiti un attimo di troppo e ti bloccano.", "La strada è senza uscita!", "Sono più veloci di te."];
const esitiLottaPredoniOk = ["Respingi il loro attacco con ferocia.", "Dopo un breve scontro, decidono che non ne vale la pena e si ritirano.", "Riesci a tenerli a bada, ma sono ancora lì.", "Ne metti uno fuori combattimento e gli altri esitano."];
const esitiLottaPredoniKo = ["Vieni picchiato e lasciato a terra dolorante.", "Ti derubano di quasi tutto.", "La tua resistenza è inutile, ti sopraffanno.", "Una lama ti ferisce gravemente."];
const esitiParlaPredoniOk = ["Sorprendentemente, le tue parole li convincono a lasciarti andare.", "Forse vedono qualcosa in te, o sono solo stanchi. Ti fanno cenno di passare.", "Ti squadrano, poi uno fa un cenno. 'Vattene, prima che cambiamo idea.'"];
const esitiParlaPredoniKo = ["'Belle parole, ma la pancia è vuota!' Ti attaccano.", "Ridono delle tue suppliche e si preparano a prendersi ciò che vogliono.", "Le tue parole non hanno effetto sul loro cinismo."];

const descrizioniAnimali = ["Un branco di cani selvatici dagli occhi iniettati di sangue.", "Un grosso cinghiale mutato con zanne ricurve.", "Uno sciame di ratti giganti emerge da una crepa.", "Una creatura simile a un lupo, ma con troppe zampe.", "Un volatile dall'aspetto preistorico ti osserva da un tetto."];
const esitiEvitaAnimaleOk = ["Riesci a sgattaiolare via senza farti notare.", "Passi con cautela e l'animale non ti degna di uno sguardo.", "Ti nascondi finché la minaccia non è passata.", "Sfrutti il terreno per aggirare la creatura."];
const esitiEvitaAnimaleKo = ["Sei troppo lento! L'animale ti ha visto.", "Sottovaluti la sua percezione e ti individua.", "Un passo falso rivela la tua posizione!"];
const esitiSpaventaAnimaleOk = ["Un urlo improvviso e un gesto minaccioso lo fanno indietreggiare.", "Una pietra ben lanciata lo convince a cercare prede più facili.", "Il tuo sguardo deciso lo intimorisce e si allontana.", "Batti le mani forte e la creatura fugge spaventata."];
const esitiSpaventaAnimaleKo = ["La bestia si infuria ancora di più!", "Non sembra minimamente intimorito dalla tua presenza.", "Il tuo tentativo lo rende solo più aggressivo."];
const esitiAttaccoAnimaleOk = ["Con un colpo ben assestato, respingi la creatura.", "Riesci a ferirlo abbastanza da farlo fuggire.", "Lo tieni a bada, guadagnando tempo per allontanarti."];
const esitiAttaccoAnimaleKo = ["Le sue zanne affondano nella tua carne.", "Vieni morso e sbattuto a terra.", "La sua furia ti travolge.", "Ti artiglia dolorosamente."];

const descrizioniTracce = ["Noti delle impronte insolite sul terreno.", "Qualcosa ha lasciato segni evidenti del suo passaggio.", "Ci sono tracce di sangue fresco sulla polvere.", "Impronte di stivali pesanti si dirigono verso..."];
const esitiSeguiTracceOkLoot = ["Le tracce ti portano a delle scorte nascoste!", "Seguendo le tracce trovi un piccolo nascondiglio con provviste.", "Chi ha lasciato queste tracce ha perso qualcosa per strada..."];
const esitiSeguiTracceOkLore = ["Le tracce ti conducono a un messaggio criptico inciso su un muro.", "Trovi un diario abbandonato vicino alle impronte.", "Segui le tracce fino ai resti di un piccolo accampamento con alcuni indizi."];
const esitiSeguiTracceOkPredoni = ["Le tracce ti portano dritto in un'imboscata!", "Stavi seguendo dei predoni... e ora ti hanno visto!", "Cadi nella trappola che avevano preparato."];
const esitiSeguiTracceOkNulla = ["Segui le tracce per un po', ma si perdono nel nulla.", "Le impronte finiscono bruscamente, come svanite.", "Il vento ha cancellato le tracce più avanti."];
const esitiSeguiTracceKo = ["Non riesci a seguire le tracce, si confondono.", "Perdi il sentiero e ti ritrovi fuori strada.", "Ti concentri troppo sulle tracce e non noti un pericolo imminente!"];

const descrizioniVillaggioOstile = ["Dalle tende emergono figure guardinghe con armi in pugno.", "Ti osservano in silenzio, con sospetto evidente.", "Un uomo con una cicatrice sul volto ti fa cenno di fermarti.", "Non sembrano per niente amichevoli."];
const esitiVillaggioOstileAllontanati = ["Ti allontani lentamente, senza dare le spalle. Non ti seguono.", "Fai dietrofront con cautela. Meglio non disturbare.", "Capiscono che non vuoi guai e ti lasciano andare."];
const esitiVillaggioOstileNegoziaOk = ["Dopo una tesa conversazione, ti permettono di passare, ma ti avvertono di non fermarti.", "Riesci a convincerli che sei solo di passaggio e non una minaccia.", "Ti scambiano qualche parola diffidente, poi ti ignorano."];
const esitiVillaggioOstileNegoziaKo = ["I tuoi tentativi di diplomazia falliscono. Ti intimano di andartene con minacce.", "'Non vogliamo estranei qui! Vattene o saranno guai!'", "Ti lanciano contro qualcosa per farti capire che non sei il benvenuto."];

const descrizioniPericoloAmbientaleAgilita = ["Il terreno cede sotto i tuoi piedi!", "Una vecchia trappola a scatto è nascosta tra le foglie!", "Sfiori un filo quasi invisibile...", "Una lastra di pavimento instabile si inclina pericolosamente."];
const descrizioniPericoloAmbientalePresagio = ["Detriti cadono dall'alto!", "Senti uno scricchiolio sinistro da una struttura pericolante sopra di te.", "Un forte odore di gas ti avverte di una perdita nelle vicinanze.", "Hai la strana sensazione di essere osservato... e poi una freccia scocca da un muro!"];
const esitiPericoloAmbientaleEvitato = ["Riesci a evitare il peggio grazie ai tuoi riflessi pronti!", "Il tuo istinto ti salva all'ultimo secondo!", "Balzi indietro appena in tempo!", "Ti fermi giusto un attimo prima di finire nella trappola."];
const esitiPericoloAmbientaleColpito = ["Non sei abbastanza veloce! Vieni colpito.", "La trappola scatta, ferendoti.", "Vieni travolto dai detriti.", "Una fitta di dolore ti attraversa la gamba."];

// Nuovo: Dilemma Morale
const descrizioniDilemmaMorale = ["Senti delle grida soffocate provenire da un edificio vicino.", "Vedi del fumo alzarsi da dietro una collina, accompagnato da rumori di lotta.", "Una figura corre verso di te, inseguita da altri.", "Trovi una cassa chiusa con uno strano simbolo, sembra importante..."];
const esitiDilemmaMoraleIndagaOkPositivo = ["Intervieni e riesci a salvare un innocente dai suoi aggressori. Ti ringrazia offrendoti delle provviste.", "Segui il fumo e trovi i resti di uno scontro. Trovi del loot utile tra i caduti.", "Aiuti la figura inseguita a nascondersi. Era un mercante che ti ricompensa."];
const esitiDilemmaMoraleIndagaOkNegativo = ["Arrivi troppo tardi. Le grida sono cessate. Trovi solo morte.", "Era una trappola! I predoni ti stavano aspettando.", "L'inseguito era un ladro, e i suoi inseguitori ora se la prendono con te."];
const esitiDilemmaMoraleIndagaKo = ["Cerchi di intervenire ma sottovaluti la situazione e vieni ferito.", "Non riesci a trovare la fonte delle grida in tempo.", "Il tuo tentativo di aiuto peggiora solo le cose."];
const esitiDilemmaMoraleIgnora = ["Decidi che non sono affari tuoi e prosegui.", "La sopravvivenza viene prima di tutto. Tiri dritto.", "Volti le spalle al pericolo, un peso sulla coscienza."];

// Nuovo: Scelta Rifugio
const descrizioniRifugioStrano = ["Mentre ti riposi, noti una sezione del muro che sembra leggermente diversa.", "C'è un piccolo contenitore metallico nascosto sotto un telo logoro.", "Un simbolo familiare è inciso rozzamente sul pavimento in un angolo."];
const esitiRifugioIspezionaOkLoot = ["Rimuovendo la sezione del muro trovi un piccolo vano con del cibo extra!", "Il contenitore contiene delle munizioni utili!", "Sotto il simbolo trovi una mappa parziale o delle note."];
const esitiRifugioIspezionaOkLore = ["Il simbolo è collegato a una fazione di cui hai sentito parlare...", "Trovi un messaggio lasciato da un precedente occupante.", "Dietro il muro c'è un vecchio terminale, forse riparabile..."];
const esitiRifugioIspezionaKoTrappola = ["Era una trappola! Una piccola carica esplode ferendoti.", "Il contenitore era protetto da un meccanismo che scatta.", "Mentre ispezioni, qualcosa cade dall'alto colpendoti."];
const esitiRifugioIspezionaKoNulla = ["È solo una strana macchia sul muro.", "Il contenitore è vuoto e arrugginito.", "Il simbolo non sembra significare nulla."];
const esitiRifugioLasciaPerdere = ["Meglio non rischiare. Ti concentri sul riposo.", "La curiosità è un lusso che non puoi permetterti.", "Ignori il dettaglio e ti prepari a ripartire."];

// Nuovi testi per eventi/varianti notturne
const descrizioniPredoniNotturni = ["Figure emergono dall'oscurità più profonda.", "Approfittano del buio per tenderti un'imboscata.", "Senti il loro respiro affannoso prima di vederli."];
const descrizioniAnimaleNotturno = ["Due occhi rossi ti fissano dal buio.", "Un ringhio basso proviene da un cespuglio vicino.", "Una creatura rapida e silenziosa ti si avvicina.", "L'odore di predatore è forte nell'aria notturna."];
const descrizioniPericoloAmbientaleNotturno = ["Inciampi in qualcosa che non riesci a vedere.", "Il terreno è ancora più instabile al buio.", "Una struttura pericolante geme sinistramente sopra di te.", "Sfiori una trappola nascosta nell'oscurità."];
const descrizioniOrroreIndicibile = ["Un senso di oppressione ti gela il sangue.", "Senti una presenza maligna osservarti.", "Ombre danzano in modo innaturale ai margini della vista.", "Un sussurro disumano ti sfiora l'orecchio."];
const esitiOrroreIndicibileFugaOk = ["Scappi a gambe levate, il terrore ti mette le ali ai piedi.", "Ti nascondi tremando finché la sensazione non svanisce.", "Chiudi gli occhi e preghi, e quando li riapri... sei solo."];
const esitiOrroreIndicibileFugaKo = ["La paura ti paralizza.", "Non riesci a sfuggire alla sensazione opprimente.", "Qualcosa ti tocca... freddo e innaturale. Perdi lucidità."]; // Potrebbe dare penalità a stats mentali?
const esitiOrroreIndicibileAffrontaOk = ["Stringi i denti e resisti all'ondata di terrore. La presenza si ritira.", "Urli la tua sfida nell'oscurità, e il silenzio che segue è quasi peggiore... ma sei ancora vivo.", "Accendi una luce improvvisa, e l'orrore rifugge da essa."]; // Raro successo
const esitiOrroreIndicibileAffrontaKo = ["Il tuo coraggio vacilla di fronte all'ignoto.", "Vieni sopraffatto da visioni terrificanti.", "Senti la tua sanità mentale scivolare via..."]; // Danno HP o status negativo?


// --- Variabili di Stato ---
let player = {}; let map = []; let messages = []; let gameActive = false; let eventScreenActive = false; let currentEventChoices = []; let currentEventContext = null;
let dayNightCounter = 0; // Contatore passi diurni
let isDay = true; // Flag Giorno/Notte
let daysSurvived = 0; // Contatore giorni completati

// --- Riferimenti DOM (Definiti subito) ---
const splashScreen=document.getElementById('splash-screen');
const gameContainer=document.getElementById('game-container');
const endScreen=document.getElementById('end-screen');
const endTitle=document.getElementById('end-title');
const endMessage=document.getElementById('end-message');
const mapDisplay=document.getElementById('map-display');
const introScreen=document.getElementById('intro-screen');
const statsList=document.getElementById('stats-list');
const statHp=document.getElementById('stat-hp'); const statMaxHp=document.getElementById('stat-maxhp');
const statVig=document.getElementById('stat-vig'); const statPot=document.getElementById('stat-pot');
const statAgi=document.getElementById('stat-agi'); const statTra=document.getElementById('stat-tra');
const statInf=document.getElementById('stat-inf'); const statPre=document.getElementById('stat-pre');
const statAda=document.getElementById('stat-ada'); const statAcq=document.getElementById('stat-acq');
const statFood=document.getElementById('stat-food'); const statWater=document.getElementById('stat-water');
const posX=document.getElementById('pos-x'); const posY=document.getElementById('pos-y');
const tileType=document.getElementById('tile-type');
const statDayTime=document.getElementById('stat-day-time'); // Aggiunta variabile per tempo rimanente
const messagesList=document.getElementById('messages');
const moveButtons=document.querySelectorAll('#controls button'); // Seleziona solo i bottoni di movimento
const eventOverlay=document.getElementById('event-overlay');
const eventTitle=document.getElementById('event-title');
const eventContent=document.getElementById('event-content');
const legendList=document.getElementById('legend-list');
const continueButton=eventOverlay.querySelector('.continue-button');

// --- FUNZIONI UTILITY ---
function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function getRandomText(arr) { if (!arr || arr.length === 0) return ""; return arr[getRandomInt(0, arr.length - 1)]; }
function addMessage(msg, type = 'info', emphasize = false) { if(typeof msg !== 'string') msg = String(msg); const maxLogMsgLength = 70; let displayMsg = msg.length > maxLogMsgLength ? msg.substring(0, maxLogMsgLength) + '...' : msg; messages.unshift(`${emphasize ? '<span class="log-warning">' : ''}> ${displayMsg}${emphasize ? '</span>' : ''}`); if (messages.length > MAX_MESSAGES) { messages.pop(); } renderMessages(); }

// --- FUNZIONI DI GIOCO ---

// startGame - Mostra l'introduzione (Nome originale: startGame, ma la logica è in proceedToGame)
function startGame() {
    console.log("[startGame] Showing Intro");
    splashScreen.style.display = 'none';
    introScreen.style.display = 'flex'; // Mostra intro invece del gioco
    gameContainer.style.display = 'none';
    endScreen.style.display = 'none';
}

// proceedToGame - Inizializza e avvia il gioco dopo l'intro
function proceedToGame() {
    console.log("[proceedToGame] Starting Game Logic");
    introScreen.style.display = 'none'; // Nasconde intro
    gameContainer.style.display = 'flex'; // Mostra gioco

    messages = [];
    player = {};
    map = [];
    gameActive = false;
    eventScreenActive = false;
    // Inizializza Variabili Ciclo Giorno/Notte
    dayNightCounter = 0;
    isDay = true;
    daysSurvived = 0;

    // Inizializza gioco (prima in startGame)
    try {
        generateCharacter();
        if (!player || typeof player.vigore !== 'number') throw new Error("Player Gen Fail");
        console.log("Char OK", player);
        generateMap();
        if (!map || map.length === 0 || typeof player.x !== 'number') throw new Error("Map/Pos Gen Fail");
        console.log("Map OK, Player Pos:", player.x, player.y);
    } catch(e) {
        console.error("INIT ERR:", e);
        if(mapDisplay) mapDisplay.textContent = `ERRORE INIZIALIZZAZIONE: ${e.message}`;
        return; // Ferma se l'inizializzazione fallisce
    }

    gameActive = true;
    eventOverlay.style.display = 'none';

    // Render UI (prima in startGame)
    try {
        renderLegend();
        renderStats();
        renderMap(); // Render mappa dopo che posizione player è definita
        renderMessages(); // Pulisce log precedente se c'era
        // Aggiornato messaggio iniziale
        addMessage(`Inizio viaggio. HP:${player.hp}, Cibo:${player.food}, Acqua:${player.water}. È Giorno.`);
        console.log("Initial Render OK");
    } catch (e) {
        console.error("RENDER ERR:", e);
        if(mapDisplay) mapDisplay.textContent = "Errore nel rendering iniziale!";
        gameActive = false; // Impedisce di giocare se il rendering fallisce
    }

    if (gameActive) {
        enableControls();
        setupInputListeners(); // Imposta listener solo se il gioco è pronto
    }
    console.log("[proceedToGame] Game Setup Complete.");
}

function generateCharacter() {
    player={name:"Ultimo",vigore:9+getRandomInt(0,2),potenza:9+getRandomInt(0,2),agilita:14+getRandomInt(0,2),tracce:14+getRandomInt(0,2),influenza:6+getRandomInt(0,2),presagio:7+getRandomInt(0,2),adattamento:9+getRandomInt(0,2),acquisita:8+getRandomInt(0,2),maxHp:0,hp:0,x:undefined,y:undefined,food:STARTING_FOOD,water:STARTING_WATER,ammo:0,movesCounter:0}; player.maxHp=10+player.vigore; player.hp=player.maxHp;
}
function generateMap() {
    map = []; let sPos=null, ePos=null; for(let y=0;y<MAP_HEIGHT;y++){map[y]=[]; for(let x=0;x<MAP_WIDTH;x++){let t=TILE_SYMBOLS.PLAINS; const r=Math.random(); if(r<0.1)t=TILE_SYMBOLS.MOUNTAIN; else if(r<0.2)t=TILE_SYMBOLS.FOREST; else if(r<0.26)t=TILE_SYMBOLS.RIVER; else if(r<0.30)t=TILE_SYMBOLS.VILLAGE; else if(r<0.32)t=TILE_SYMBOLS.CITY; else if(r<0.35)t=TILE_SYMBOLS.REST_STOP; map[y][x]={type:t,visited:false};}} let sx=getRandomInt(1,Math.floor(MAP_WIDTH/4)); let sy=getRandomInt(1,Math.floor(MAP_HEIGHT/4)); let att=0; while((!map[sy]?.[sx] || map[sy][sx].type!==TILE_SYMBOLS.PLAINS) && att<100){ sx=getRandomInt(1,Math.floor(MAP_WIDTH/4)); sy=getRandomInt(1,Math.floor(MAP_HEIGHT/4)); att++;} if(att>=100){sx=1;sy=1;} map[sy][sx]={type:TILE_SYMBOLS.START,visited:true}; sPos={x:sx,y:sy}; let ex,ey; att=0; do{ex=getRandomInt(Math.floor(MAP_WIDTH*3/4),MAP_WIDTH-2); ey=getRandomInt(Math.floor(MAP_HEIGHT*3/4),MAP_HEIGHT-2); att++; if(att>100){ex=MAP_WIDTH-2;ey=MAP_HEIGHT-2; break;}}while(!map[ey]?.[ex] || map[ey][ex].type===TILE_SYMBOLS.MOUNTAIN || map[ey][ex].type===TILE_SYMBOLS.RIVER || (ex===sx && ey===sy)); if(map[ey]?.[ex]){map[ey][ex]={type:TILE_SYMBOLS.END,visited:false};} else {map[MAP_HEIGHT-2][MAP_WIDTH-2]={type:TILE_SYMBOLS.END,visited:false};} player.x=sPos.x; player.y=sPos.y;
}

function renderStats() {
    try{
        statHp.textContent=player?.hp??'--';statMaxHp.textContent=player?.maxHp??'--';
        statVig.textContent=player?.vigore??'--';statPot.textContent=player?.potenza??'--';
        statAgi.textContent=player?.agilita??'--';statTra.textContent=player?.tracce??'--';
        statInf.textContent=player?.influenza??'--';statPre.textContent=player?.presagio??'--';
        statAda.textContent=player?.adattamento??'--';statAcq.textContent=player?.acquisita??'--';
        statFood.textContent=player?.food??'--';statWater.textContent=player?.water??'--';
        statFood.classList.toggle('low-resource',(player?.food??99)<=1);
        statWater.classList.toggle('low-resource',(player?.water??99)<=1);
        posX.textContent=player?.x??'--';posY.textContent=player?.y??'--';
        if(gameActive&&map?.[player?.y]?.[player?.x]){const t=map[player.y][player.x];tileType.textContent=TILE_DESC[t.type]||'???';}else if(gameActive){tileType.textContent='Inizio...';}else{tileType.textContent='--';}
        // Aggiorna indicatore tempo rimanente
        if(statDayTime) {
            if(isDay) {
                statDayTime.textContent = `${DAY_LENGTH_MOVES - dayNightCounter} p.`;
            } else {
                statDayTime.textContent = 'Notte';
            }
        }
    }catch(e){console.error("Err Stats:",e);if(tileType)tileType.textContent='ERR';}
}
function renderMessages() {
    try{messagesList.innerHTML = messages.map(msg => `<li>${msg}</li>`).join('');}catch(e){console.error("Err Msgs:",e);}}
function renderLegend() {
    try{legendList.innerHTML=''; const li=[{s:TILE_SYMBOLS.PLAYER,d:TILE_DESC['@']},{s:TILE_SYMBOLS.PLAINS,d:TILE_DESC['.']},{s:TILE_SYMBOLS.FOREST,d:TILE_DESC['F']},{s:TILE_SYMBOLS.MOUNTAIN,d:TILE_DESC['M']},{s:TILE_SYMBOLS.RIVER,d:TILE_DESC['~']},{s:TILE_SYMBOLS.VILLAGE,d:TILE_DESC['V']},{s:TILE_SYMBOLS.CITY,d:TILE_DESC['C']},{s:TILE_SYMBOLS.REST_STOP,d:TILE_DESC['R']},{s:TILE_SYMBOLS.START,d:TILE_DESC['S']},{s:TILE_SYMBOLS.END,d:TILE_DESC['E']}]; li.forEach(i=>{const tc=`tile-${Object.keys(TILE_SYMBOLS).find(k=>TILE_SYMBOLS[k]===i.s)?.toLowerCase().replace('_','-')||'unk'}`; const ec=i.s===TILE_SYMBOLS.END?'tile-end':''; legendList.innerHTML+=`<li><span class="legend-symbol ${tc} ${ec}">${i.s}</span> = ${i.d}</li>`;});}catch(e){console.error("Err Legend:",e);}}
function renderMap() {
    const d=mapDisplay; if(!d)return; if(!player||typeof player.x!=='number'){d.textContent="ERR Player"; return;} if(!map||!map.length){d.textContent="ERR Map"; return;} player.x=Math.max(0, Math.min(MAP_WIDTH-1, player.x)); player.y=Math.max(0, Math.min(MAP_HEIGHT-1, player.y)); let s=""; const vw=40,vh=25,hw=Math.floor(vw/2),hh=Math.floor(vh/2); let sx=Math.max(0,player.x-hw), sy=Math.max(0,player.y-hh); sx=Math.min(sx,MAP_WIDTH-vw); sy=Math.min(sy,MAP_HEIGHT-vh); sx=Math.max(0,sx); sy=Math.max(0,sy); let ex=Math.min(MAP_WIDTH,sx+vw), ey=Math.min(MAP_HEIGHT,sy+vh); try{for(let y=sy; y<ey; y++){if(y<0||y>=map.length)continue; for(let x=sx; x<ex; x++){if(x<0||!map[y]||x>=map[y].length)continue; if(x===player.x && y===player.y){s+=`<span class="player-marker">${TILE_SYMBOLS.PLAYER}</span>`;} else {const t=map[y][x];const symb=t?.type||'?';let tclass=`tile-${Object.keys(TILE_SYMBOLS).find(k=>TILE_SYMBOLS[k]===symb)?.toLowerCase().replace(/_/g,'-')||'unk'}`; let vclass=t?.visited?'visited':''; let eclass=symb===TILE_SYMBOLS.END?'tile-end':''; s+=`<span class="${tclass} ${vclass} ${eclass}">${symb}</span>`;}}s+="\n";}}catch(e){console.error(e); d.textContent="Err Render Loop!"; return;} d.innerHTML=s;}

function disableControls(disabled=true){moveButtons.forEach(btn=>btn.disabled=disabled);}
function enableControls(){if(gameActive)moveButtons.forEach(btn=>btn.disabled=false);}
function performSkillCheck(statKey, difficulty){const val=player[statKey]||5; const roll=getRandomInt(1,20); const bonus=Math.floor((val-10)/2); const total=roll+bonus; const success=total>=difficulty; const txt=`Prova ${statKey.toUpperCase()}(D${difficulty}): D${roll}+${bonus}=${total} -> ${success?"SUCCESSO!":'<span class="danger-text">FALLIMENTO!</span>'}`; return{success, text:txt};}

function showEventPopup(title, content, choices=[], checkResult=null, consequenceText="") {
    // Modificato: Permette popup anche se !gameActive se sono schermate finali.
    if (!gameActive && !(title.includes("Fine") || title.includes("Destinazione"))) return;
    eventTitle.textContent=title; let choiceHTML=""; let fullHTML=content.replace(/\n/g,'<br>');
    if(checkResult){fullHTML+=`<br>${checkResult.text}`; if(consequenceText){fullHTML+=`<br>${consequenceText.replace(/\n/g,'<br>')}`;}}else if(consequenceText&&!checkResult){fullHTML+=`<br>${consequenceText.replace(/\n/g,'<br>')}`;}
    // Genera HTML per i pulsanti di scelta
    if (choices?.length > 0) {
        currentEventChoices = choices; // Mantiene la lista per il keypress fallback
        choices.forEach(c => {
            // Crea un bottone per ogni scelta, chiama handleEventChoice con la chiave corretta
            choiceHTML += `<div class="event-choice"><button onclick="handleEventChoice('${c.key}')">${c.text}</button></div>`;
        });
        continueButton.classList.add('hidden');
    } else {
        currentEventChoices = []; // Nessuna scelta
        currentEventContext = null; // Resetta contesto se non ci sono scelte (es. popup di solo risultato)
        continueButton.classList.remove('hidden');
    }

    eventContent.innerHTML = fullHTML + choiceHTML; // Inserisce contenuto e pulsanti (o nessuno)
    eventOverlay.style.display = 'block';
    disableControls(true); // Disabilita controlli mappa mentre popup è attivo
    eventScreenActive = true;
    eventContent.scrollTop = eventContent.scrollHeight; // Scrolla in fondo se contenuto lungo
}
function hideEventScreen(){if(!gameActive && eventScreenActive) { /* Potrebbe servire logica specifica se il gioco finisce con popup aperto? */ } if(!eventScreenActive) return; eventOverlay.style.display='none';eventScreenActive=false;currentEventChoices=[];currentEventContext=null; if(gameActive) enableControls();}

function showEndGameMessage(isVictory){
    gameActive=false;disableControls(true);eventOverlay.style.display='none';gameContainer.style.display='none';splashScreen.style.display='none';
    if(isVictory){
        endTitle.textContent="Destinazione Raggiunta...";
        // Testo Vittoria Specifico
        endMessage.innerHTML=`...Sei arrivato. Davanti a te, una vecchia porta blindata semi-sepolta, con uno strano simbolo inciso... Il simbolo di tuo padre... L\'aria all\'interno è viziata... Un terminale spento è incassato nella parete... È questo il \'Safe Place\'? ...Il tuo viaggio per ora termina qui, Ultimo. Ma la storia... sembra appena iniziata. (Fine del Prototipo - Capitolo 1)`.replace(/\n/g, '<br>');
    } else {
        endTitle.textContent="Il Viaggio Termina Qui";
        // Testo Sconfitta Specifico
        endMessage.textContent="Le ferite, la fame, la disperazione... Questo mondo non perdona. Sei caduto, Ultimo. Le rovine reclamano un\'altra vita. La ricerca del Safe Place finisce nell\'oblio.";
    }
    endScreen.style.display='flex';
}

function handleTileEvent(tile) {
    if (!tile || !gameActive) return false;
    tile.visited = true;
    const t = tile.type;
    let title = "", desc = "", popup = false, changed = false, choices = [], check = null, cons = "", immediateEvent = false;
    let statsChanged = false; // Flag specifico per modifiche stats
    let penaltyApplied = false; // Flag per penalità applicate nel rifugio notturno

    addMessage(`Entri: ${TILE_DESC[t] || '???'}${(isDay ? '' : ' (Notte)')}`);

    // Probabilità base e pool eventi modificati da Giorno/Notte
    let baseEventChance = 0;
    let allowedEventsOnTile = [];
    switch(t) {
        case TILE_SYMBOLS.PLAINS: baseEventChance = 0.08; allowedEventsOnTile = ['animale', 'loot_semplice', 'lore']; break;
        case TILE_SYMBOLS.FOREST: baseEventChance = 0.25; allowedEventsOnTile = ['animale', 'tracce_strane', 'pericolo_ambientale', 'lore', 'dilemma_morale']; break;
        case TILE_SYMBOLS.MOUNTAIN: baseEventChance = 0.20; allowedEventsOnTile = ['animale', 'pericolo_ambientale', 'lore']; break;
        case TILE_SYMBOLS.RIVER: baseEventChance = 0.05; allowedEventsOnTile = ['loot_semplice']; break;
        case TILE_SYMBOLS.CITY: baseEventChance = 0.65; allowedEventsOnTile = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale']; break;
        case TILE_SYMBOLS.VILLAGE: baseEventChance = 0.50; allowedEventsOnTile = ['villaggio_ostile', 'loot_semplice', 'lore', 'tracce_strane', 'dilemma_morale']; break;
    }

    if (!isDay) { // È notte!
        baseEventChance *= 2; // Raddoppia la probabilità base di evento casuale
        // Pool di eventi notturni specifici e più pericolosi
        const nightPool = ['predoni', 'animale_notturno', 'pericolo_ambientale_notturno', 'orrore_indicibile', 'tracce_strane']; // Tracce anche di notte
        // Filtra allowedTypes per mantenere solo quelli notturni validi (ignora loot_semplice, lore, dilemma morale di notte?)
        const possibleNightEvents = allowedEventsOnTile.filter(type => nightPool.includes(type));
        if (possibleNightEvents.length > 0) {
             allowedEventsOnTile = possibleNightEvents; // Usa solo gli eventi notturni possibili per questa tile
        } else {
            // Se la tile non ha eventi notturni specifici (es. Fiume), non succede nulla di casuale di notte? O mettiamo un fallback?
            // Mettiamo un fallback molto basso a eventi generici notturni?
             if(Math.random() < 0.05) { // Piccola chance di evento generico notturno anche dove non previsto
                 allowedEventsOnTile = nightPool;
             } else {
                 baseEventChance = 0; // Nessun evento casuale qui di notte
             }
        }
        // Riduciamo la chance base se il pool notturno è vuoto?
        if (allowedEventsOnTile.length === 0) baseEventChance = 0;
    }

    // Controlla se scatta un evento casuale GENERICO sulla tile
    if (baseEventChance > 0 && Math.random() < baseEventChance) {
        triggerRandomEvent(allowedEventsOnTile); // Passa il pool corretto (giorno o notte filtrato)
        return true; // L'evento casuale gestisce il popup, blocca map render
    }

    // Flavor text per tiles comuni (senza popup)
    let flavor = "";
    let flavorPool = [];
    if (Math.random() < 0.25) { // Probabilità flavor text leggermente aumentata
        switch (t) {
            case TILE_SYMBOLS.PLAINS: flavorPool = isDay ? flavorTextsPlains : flavorTextsNightPlains; break;
            case TILE_SYMBOLS.FOREST: flavorPool = isDay ? flavorTextsForest : flavorTextsNightForest; break;
            case TILE_SYMBOLS.MOUNTAIN: flavorPool = flavorTextsMountain; break; // Aggiungere night variant se serve
            case TILE_SYMBOLS.RIVER: flavorPool = flavorTextsRiver; break; // Aggiungere night variant se serve
            case TILE_SYMBOLS.CITY: flavorPool = flavorTextsCity; break; // Aggiungere night variant se serve
            case TILE_SYMBOLS.VILLAGE: flavorPool = flavorTextsVillage; break; // Aggiungere night variant se serve
            case TILE_SYMBOLS.REST_STOP: flavorPool = flavorTextsRestStop; break; // Aggiungere night variant se serve
        }
        if (flavorPool && flavorPool.length > 0) {
             flavor = getRandomText(flavorPool);
             if (flavor) addMessage(flavor);
        }
    }

    // Logica eventi specifici per tile
    switch (t) {
        case TILE_SYMBOLS.REST_STOP: // RIFUGIO ('R')
            if (!isDay) { // GIOCATORE RAGGIUNGE IL RIFUGIO DI NOTTE!
                title = "Rifugio Trovato (Notte)";
                desc = "Sei riuscito a trovare un rifugio appena in tempo! L'oscurità all'esterno sembra meno minacciosa da qui dentro. Puoi finalmente riposare fino all'alba.";
                popup = true;
                immediateEvent = true; // Mostra subito questo popup speciale

                // **FA TERMINARE LA NOTTE IMMEDIATAMENTE:**
                isDay = true; // Torna giorno
                dayNightCounter = 0; // Resetta contatore giorno
                daysSurvived++; // Incrementa giorno
                addMessage(`[FASE] Hai passato la notte al sicuro. Sorge un nuovo Giorno (Giorno ${daysSurvived}).`, 'info', true); // Aggiunto 'true' per enfasi

                // **CONSUMO RISORSE FINE GIORNATA/NOTTE:**
                player.food = Math.max(0, player.food - NIGHT_FOOD_COST);
                player.water = Math.max(0, player.water - NIGHT_WATER_COST);
                addMessage(`[CONSUMO] Il riposo ha richiesto energie (-${NIGHT_FOOD_COST} Cibo, -${NIGHT_WATER_COST} Acqua).`, 'info');
                statsChanged = true;

                // Penalità Fame/Sete
                if (player.food === 0) {
                    player.hp = Math.max(0, player.hp - HUNGER_PENALTY_HP);
                    addMessage(`[ATTENZIONE] Fame! Hai passato la notte senza cibo (-${HUNGER_PENALTY_HP} HP)`, 'info', true);
                    penaltyApplied = true;
                }
                if (player.water === 0) {
                    player.hp = Math.max(0, player.hp - THIRST_PENALTY_HP);
                    addMessage(`[ATTENZIONE] Sete! Hai passato la notte senz'acqua (-${THIRST_PENALTY_HP} HP)`, 'info', true);
                    penaltyApplied = true;
                }

                // Piccolo Recupero HP per il riposo sicuro? (Opzionale)
                if (player.hp < player.maxHp && !penaltyApplied) {
                    const recoveredHp = getRandomInt(1, 2);
                    player.hp = Math.min(player.maxHp, player.hp + recoveredHp); // Piccolo recupero
                    cons = `Riprendi un po' di fiato (+${recoveredHp} HP).`;
                    statsChanged = true; // Anche recupero HP cambia stats
                } else if (penaltyApplied) {
                    cons = "Sei esausto e affamato/assetato, il riposo non basta.";
                    // Non recupera HP se ha subito penalità
                } else {
                    cons = "Passi la notte relativamente tranquillo.";
                }
                // NON triggera l'evento del rifugio con check/scelta qui. L'evento è la transizione stessa.
                choices = []; // Nessuna scelta qui

            } else { // GIOCATORE RAGGIUNGE RIFUGIO DI GIORNO
                title = "Rifugio Esplorato (Giorno)";
                desc = "Trovi un rifugio. Potrebbe essere utile fermarsi più tardi, ma ora è giorno e puoi solo dargli un'occhiata veloce.";
                popup = true;
                immediateEvent = true;
                choices = []; // Nessuna scelta per ora, solo info

                // Fa avanzare POCO il tempo diurno, NON termina la giornata
                let timePassed = getRandomInt(1, 3); // Passano da 1 a 3 "step" del giorno
                dayNightCounter = Math.min(dayNightCounter + timePassed, DAY_LENGTH_MOVES); // Avanza ma non supera limite
                cons = `Passi ${timePassed} unità di tempo esplorando il luogo.`;
                if (dayNightCounter >= DAY_LENGTH_MOVES) { // Se l'esplorazione fa scattare la notte
                    isDay = false; dayNightCounter = 0;
                    addMessage("[FASE] L'esplorazione ti ha trattenuto più del previsto. Cala la NOTTE!", 'info', true);
                    cons += " L'oscurità ti sorprende!";
                } else {
                    cons += ` Rimangono ${DAY_LENGTH_MOVES - dayNightCounter} unità di tempo prima del tramonto.`;
                }

                 // Check Adattamento per loot veloce (opzionale)
                 if (Math.random() < 0.3) {
                     check = performSkillCheck('adattamento', 9);
                     if(check.success){
                        const resType = Math.random() < 0.5 ? 'food' : 'water';
                        const foundAmount = 1; // Solo 1 risorsa rapida
                        player[resType] += foundAmount;
                        cons += `
Trovi rapidamente ${foundAmount} ${resType==='food'?'Cibo':'Acqua'}.`;
                        statsChanged = true;
                     } else {
                         // check non nullo ma fallito, potrebbe mostrare il tiro fallito
                     }
                 }
            }
            break;
        case TILE_SYMBOLS.VILLAGE:
            if (!popup && !flavor) {
                addMessage(getRandomText(flavorTextsVillage) || (isDay ? "L'accampamento è stranamente silenzioso." : "Nessuna luce, sembra disabitato..."));
            }
            // Potrebbe triggerare evento 'villaggio_ostile' (gestito dalla casualità sopra)
            break;
        case TILE_SYMBOLS.CITY:
             if (!popup && !flavor) {
                 addMessage(getRandomText(flavorTextsCity) || (isDay ? "Le rovine si estendono a perdita d'occhio." : "Le ombre della città di notte celano pericoli..."));
             }
            break;
        case TILE_SYMBOLS.END:
            if (gameActive) showEndGameMessage(true);
            return false; // Nessun popup evento qui
    }

    // Applicazione Penalità Fame/Sete calcolata DENTRO l'evento del rifugio notturno
    // L'aggiornamento stats e game over check deve avvenire DOPO le modifiche
    if(statsChanged) {
         renderStats(); // Aggiorna subito le stats dopo la penalità o loot o recupero HP
         if(checkGameOver()) return true; // Esce se morto, ma blocca render mappa successivo
     }

    // Mostra popup se necessario e gestito qui (non da evento casuale)
    if(popup && immediateEvent && !eventScreenActive && choices.length === 0) {
         showEventPopup(title, desc, [], check, cons);
         return true; // Popup mostrato, blocca render mappa
    } else if (popup && immediateEvent && !eventScreenActive && choices.length > 0) {
         showEventPopup(title, desc, choices, null, ""); // Mostra scelte (caso rifugio giorno con check adattamento?)
         return true; // Popup mostrato, blocca render mappa
    }
    return false; // Nessun popup mostrato qui
}


function triggerRandomEvent(allowedTypes = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale', 'animale_notturno', 'pericolo_ambientale_notturno', 'orrore_indicibile']) {
    if (!gameActive || eventScreenActive || allowedTypes.length === 0) return;

    let eventType = "";
    let difficultyModifier = 0; // Modificatore difficoltà per la notte

    if (!isDay) { // È NOTTE!
        // Pool di eventi notturni specifici e più pericolosi
        const nightPool = ['predoni', 'animale_notturno', 'pericolo_ambientale_notturno', 'orrore_indicibile', 'tracce_strane']; // Pool eventi possibili di notte
        // Filtra allowedTypes per mantenere solo quelli notturni validi per questa tile
        const possibleNightEvents = allowedTypes.filter(type => nightPool.includes(type));

        if (possibleNightEvents.length > 0) {
            eventType = getRandomText(possibleNightEvents);
        } else {
            // Fallback se la tile non aveva eventi notturni specifici permessi
            // Questo non dovrebbe accadere con la logica in handleTileEvent che imposta baseChance a 0
            // Ma per sicurezza, scegliamo uno a caso dal pool notturno generale
            eventType = getRandomText(nightPool);
            console.warn("Triggering fallback night event:", eventType);
        }
        difficultyModifier = getRandomInt(1, 3); // Aggiunge +1 a +3 alla difficoltà di notte
        addMessage(`[NOTTE] Qualcosa si muove nell'ombra... (${eventType.replace(/_/g, ' ')})`, 'info', true);
    } else { // È GIORNO
         eventType = getRandomText(allowedTypes);
         // Non loggare loot e lore qui, ma nel loro case
         if (eventType !== 'lore' && eventType !== 'loot_semplice') {
             addMessage(`[EVENTO] ${eventType.replace(/_/g, ' ')}!`, 'info', true);
         }
    }

    let title = "Evento Inaspettato", desc = "", changed = false, choices = [], check = null, cons = "";
    // Salva anche il modificatore di difficoltà nel contesto
    currentEventContext = { event: eventType, difficultyMod: difficultyModifier, difficulty: 12 }; // Default difficulty

    switch (eventType) {
        case 'predoni':
            title = isDay ? "Predoni!" : "Imboscata Notturna!";
            desc = `${getRandomText(isDay ? descrizioniPredoni : descrizioniPredoniNotturni)} ${getRandomText(vociPredoni)}
Ti bloccano la strada!`;
            choices = [{ key: 'F', text: "Fuggi (Agilità)" },{ key: 'C', text: "Combatti (Potenza)" },{ key: 'P', text: "Parla (Influenza)" }];
            currentEventContext.difficulty = 12; // Difficoltà base
            break;
        case 'animale': // Evento animale DIURNO
            title = "Animale Selvatico!";
            const animale = getRandomText(descrizioniAnimali); desc = `Un ${animale} ti sbarra il passo, ringhiando.`;
            choices = [{ key: 'E', text: "Evita (Agilità/Tracce)" },{ key: 'S', text: "Spaventa (Influenza)" },{ key: 'A', text: "Attacca (Potenza)" }];
            currentEventContext.difficulty = 11;
            break;
        case 'animale_notturno': // Variante NOTTURNA
            title = "Bestia Notturna!";
            desc = getRandomText(descrizioniAnimaleNotturno);
            choices = [
                { key: 'E', text: "Evita furtivamente (Agilità)" }, // Notte: più difficile evitare?
                { key: 'A', text: "Attacca nell'ombra (Potenza)" }, // Notte: combattere è più rischioso?
                { key: 'O', text: "Osserva da lontano (Tracce)" } // Nuova opzione? Per capire cosa sia?
            ];
            currentEventContext.difficulty = 13; // Difficoltà base più alta
            break;
        case 'tracce_strane':
            title = "Tracce Strane"; desc = getRandomText(descrizioniTracce);
            choices = [{ key: 'I', text: "Ignora" },{ key: 'S', text: "Segui (Tracce)" }];
            currentEventContext.difficulty = 13; // Difficoltà base
            break;
        case 'villaggio_ostile':
            title = "Accampamento Ostile"; desc = getRandomText(descrizioniVillaggioOstile);
            choices = [{ key: 'A', text: "Allontanati" },{ key: 'N', text: "Negozia (Influenza)" }];
            currentEventContext.difficulty = 14; // Difficoltà base
            break;
        case 'loot_semplice': // Solo di giorno
            if (!isDay) { hideEventScreen(); return; } // Non dovrebbe accadere
            title = "Oggetti Abbandonati";
            const lootType = Math.random() < 0.6 ? 'Cibo' : 'Acqua';
            const amount = getRandomInt(1, 3);
            desc = `Frugando in giro, trovi ${amount} unità di ${lootType} in un contenitore nascosto.`;
            if (lootType === 'Cibo') player.food += amount; else player.water += amount;
            changed = true; choices = [];
            addMessage(`Hai trovato ${amount} ${lootType}.`, 'info');
            break;
        case 'lore': // Solo di giorno
            if (!isDay) { hideEventScreen(); return; } // Non dovrebbe accadere
            title = "Eco dal Passato"; desc = `Trovi un frammento di conoscenza perduta:
"${getRandomText(loreFragments)}"`;
            addMessage("Hai trovato un frammento di lore.", 'info'); choices = [];
            break;
        case 'pericolo_ambientale': // Diurno
            title = "Pericolo Improvviso!";
            const hazardTypeDay = Math.random();
            if (hazardTypeDay < 0.5) {
                 desc = getRandomText(descrizioniPericoloAmbientaleAgilita); choices = [ { key: 'S', text: "Schiva (Agilità)" } ];
                 currentEventContext.subType = 'agilita_check'; currentEventContext.difficulty = 12; currentEventContext.damage = getRandomInt(1, 2);
            } else {
                desc = getRandomText(descrizioniPericoloAmbientalePresagio); choices = [ { key: 'R', text: "Reagisci (Presagio)" } ];
                currentEventContext.subType = 'presagio_check'; currentEventContext.difficulty = 13; currentEventContext.damage = getRandomInt(1, 3);
            }
            break;
        case 'pericolo_ambientale_notturno': // Notturno
             title = "Pericolo nell'Ombra!";
             desc = getRandomText(descrizioniPericoloAmbientaleNotturno);
             // Check più difficili di notte
             const hazardTypeNight = Math.random();
             if (hazardTypeNight < 0.5) {
                 choices = [ { key: 'S', text: "Balza via (Agilità)" } ];
                 currentEventContext.subType = 'agilita_check'; currentEventContext.difficulty = 13; currentEventContext.damage = getRandomInt(1, 3); // Danno leggermente aumentato
             } else {
                 choices = [ { key: 'P', text: "Percepisci (Presagio)" } ];
                 currentEventContext.subType = 'presagio_check'; currentEventContext.difficulty = 14; currentEventContext.damage = getRandomInt(2, 3); // Danno leggermente aumentato
             }
             break;
        case 'dilemma_morale': // Solo di giorno? O anche di notte con varianti? Per ora solo giorno
             if (!isDay) { hideEventScreen(); return; } // Non dovrebbe accadere
             title = "Dilemma Morale"; desc = getRandomText(descrizioniDilemmaMorale);
             choices = [{ key: 'I', text: "Indaga / Intervieni (Presagio?)" },{ key: 'N', text: "Non è affar mio / Ignora" }];
             currentEventContext.difficulty = 12; // Difficoltà base
             break;
        case 'orrore_indicibile': // Solo di notte
             title = "Orrore Indicibile"; desc = getRandomText(descrizioniOrroreIndicibile);
             choices = [
                 { key: 'F', text: "Fuggi disperatamente (Agilità)" },
                 { key: 'A', text: "Affronta l'ignoto (Vigore?)" } // Resistenza mentale
             ];
             currentEventContext.difficulty = 15; // Molto difficile
             currentEventContext.sanityDamage = getRandomInt(1, 2); // Danno a stat mentale/HP se fallisce
             break;
        default:
            console.warn("Tipo evento non gestito:", eventType);
            title = "Nulla di Fatto"; desc = "Senti uno strano rumore, ma non succede nulla."; choices = [];
            break;
    }

    if (changed) { // Per loot_semplice
        renderStats();
    }
    // Mostra il popup con le scelte (o senza se loot/lore)
    showEventPopup(title, desc, choices, check, cons);
}

function handleEventChoice(choiceKey) {
    let title = "Esito", desc = "", changed = false, choices = [], check = null, cons = "";
    const ctx = currentEventContext;
    hideEventScreen(); // Nasconde il popup precedente

    if (!ctx) { console.error("handleEventChoice chiamato senza context!"); addMessage("Errore nell'elaborazione dell'evento.", 'warning'); return; }

    console.log(`Handling choice ${choiceKey} for event ${ctx.event} with diffMod ${ctx.difficultyMod || 0}`);
    const baseDifficulty = ctx.difficulty || 12; // Usa difficoltà del contesto o default
    const effectiveDifficulty = baseDifficulty + (ctx.difficultyMod || 0); // Applica modificatore notturno

    switch (ctx.event) {
        case 'predoni':
            title = "Scontro con Predoni";
            switch (choiceKey) {
                case 'F':
                    check = performSkillCheck('agilita', effectiveDifficulty);
                    if (check.success) { desc = getRandomText(esitiFugaPredoniOk); }
                    else { desc = getRandomText(esitiFugaPredoniKo); const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni colpito (-${dmg} HP).`; changed = true; }
                    break;
                case 'C':
                    check = performSkillCheck('potenza', effectiveDifficulty + 1); // Combattere è più difficile
                    if (check.success) { desc = getRandomText(esitiLottaPredoniOk); }
                    else { desc = getRandomText(esitiLottaPredoniKo); const dmg = getRandomInt(isDay ? 2 : 3, isDay ? 4 : 5); const lostFood = Math.min(player.food, getRandomInt(0, isDay ? 1 : 2)); const lostWater = Math.min(player.water, getRandomInt(0, isDay ? 1 : 2)); player.hp = Math.max(0, player.hp - dmg); player.food -= lostFood; player.water -= lostWater; cons = `Subisci danni (-${dmg} HP)`; if (lostFood > 0) cons += `, perdi cibo (-${lostFood})`; if (lostWater > 0) cons += `, perdi acqua (-${lostWater})`; cons += "."; changed = true; }
                    break;
                case 'P':
                    check = performSkillCheck('influenza', effectiveDifficulty + 2); // Parlare è più difficile
                    if (check.success) { desc = getRandomText(esitiParlaPredoniOk); }
                    else { desc = getRandomText(esitiParlaPredoniKo); const dmg = getRandomInt(isDay ? 2 : 3, isDay ? 4 : 5); const lostFood = Math.min(player.food, getRandomInt(0, isDay ? 2 : 3)); const lostWater = Math.min(player.water, getRandomInt(0, isDay ? 2 : 3)); player.hp = Math.max(0, player.hp - dmg); player.food -= lostFood; player.water -= lostWater; cons = `Subisci danni (-${dmg} HP)`; if (lostFood > 0) cons += `, perdi cibo (-${lostFood})`; if (lostWater > 0) cons += `, perdi acqua (-${lostWater})`; cons += "."; changed = true; }
                    break;
            }
            break;

        case 'animale': // Diurno
        case 'animale_notturno': // Usa la stessa logica ma con effectiveDifficulty più alta
            title = ctx.event === 'animale' ? "Incontro con Animale" : "Incontro Notturno";
             switch (choiceKey) {
                case 'E': // Evita
                    const statToUse = (player.agilita > player.tracce ? 'agilita' : 'tracce');
                    check = performSkillCheck(statToUse, effectiveDifficulty); // Usa Agilità o Tracce
                    if (check.success) { desc = getRandomText(esitiEvitaAnimaleOk); }
                    else { desc = getRandomText(esitiEvitaAnimaleKo); cons = "L'animale ti attacca!"; const dmg = getRandomInt(isDay ? 1 : 2, isDay ? 2 : 3); player.hp = Math.max(0, player.hp - dmg); cons += ` (-${dmg} HP).`; changed = true; }
                    break;
                case 'S': // Spaventa (Influenza - solo diurno?)
                    if (ctx.event === 'animale_notturno') { desc = "Non puoi spaventare ciò che non vedi bene..."; break;} // Opzione non valida di notte?
                    check = performSkillCheck('influenza', effectiveDifficulty);
                    if (check.success) { desc = getRandomText(esitiSpaventaAnimaleOk); }
                    else { desc = getRandomText(esitiSpaventaAnimaleKo); cons = "La bestia si infuria e attacca!"; const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg); cons += ` (-${dmg} HP).`; changed = true; }
                    break;
                case 'A': // Attacca (Potenza)
                    check = performSkillCheck('potenza', effectiveDifficulty);
                    if (check.success) { desc = isDay ? "Riesci a respingere l'animale." : "Colpisci alla cieca ma allontani la minaccia."; }
                    else { desc = getRandomText(esitiAttaccoAnimaleKo); const dmg = getRandomInt(isDay ? 2 : 3, isDay ? 4 : 5); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni ferito (-${dmg} HP).`; changed = true; }
                    break;
                 case 'O': // Osserva (Tracce - solo notturno)
                     if (ctx.event === 'animale') { desc = "Non c'è tempo per osservare!"; break;}
                     check = performSkillCheck('tracce', effectiveDifficulty -1); // Osservare è un po' più facile?
                     if (check.success) { desc = "Riesci a capire la natura della creatura e a evitarla senza combattere."; /* Potrebbe dare bonus Adattamento? */ }
                     else { desc = "Non riesci a capire cosa sia, e ti attacca alla sprovvista!"; cons = "Attacco improvviso!"; const dmg = getRandomInt(2, 4); player.hp = Math.max(0, player.hp - dmg); cons += ` (-${dmg} HP).`; changed = true; }
                     break;
            }
            break;

        case 'tracce_strane':
            title = "Seguendo le Tracce";
            if (choiceKey === 'I') { desc = "Decidi di non rischiare e prosegui per la tua strada."; }
            else if (choiceKey === 'S') {
                check = performSkillCheck('tracce', effectiveDifficulty); // Difficoltà influenzata da notte
                if (check.success) {
                    const outcomeRoll = Math.random();
                    if (isDay && outcomeRoll < 0.35) { // 35% Trova loot (solo giorno?)
                         const foundLootType = Math.random() < 0.5 ? 'Cibo' : 'Acqua'; const foundAmount = getRandomInt(1, 3);
                         desc = `${getRandomText(esitiSeguiTracceOkLoot)} Trovi ${foundAmount} ${foundLootType}.`;
                         if (foundLootType === 'Cibo') player.food += foundAmount; else player.water += foundAmount; changed = true;
                    } else if (isDay && outcomeRoll < 0.55) { // 20% Trova Lore (solo giorno?)
                        desc = `${getRandomText(esitiSeguiTracceOkLore)}
"${getRandomText(loreFragments)}"`;
                        addMessage("Hai trovato della lore seguendo le tracce.", 'info');
                    } else if (outcomeRoll < 0.80) { // 25% Pericolo (Predoni/Animale Notturno)
                        desc = getRandomText(esitiSeguiTracceOkPredoni);
                        // Innesca altro evento (notturno se è notte)
                        triggerRandomEvent(isDay ? ['predoni'] : ['predoni', 'animale_notturno']); return;
                    } else { // 20% Nulla
                        desc = getRandomText(esitiSeguiTracceOkNulla);
                    }
                } else {
                    desc = getRandomText(esitiSeguiTracceKo);
                    if(Math.random() < (isDay ? 0.3 : 0.5)) { // 30-50% chance di penalità
                         const dmg = 1; player.hp = Math.max(0, player.hp - dmg);
                         cons = `La disattenzione ti costa cara (-${dmg} HP).`; changed = true;
                    }
                }
            }
            break;

         case 'villaggio_ostile': // Evento diurno? O modificare per notte?
            title = "Accampamento Guardingo";
            if (choiceKey === 'A') { desc = getRandomText(esitiVillaggioOstileAllontanati); }
            else if (choiceKey === 'N') {
                check = performSkillCheck('influenza', effectiveDifficulty); // Usa effectiveDifficulty
                if (check.success) { desc = getRandomText(esitiVillaggioOstileNegoziaOk); }
                else { desc = getRandomText(esitiVillaggioOstileNegoziaKo); /* Penalità? Forse attacco? */
                    if(Math.random() < 0.4) {
                        cons = "Ti attaccano!"; triggerRandomEvent(['predoni']); return; // Fallimento negoziazione -> attacco
                    }
                }
            }
            break;

        case 'pericolo_ambientale': // Diurno
        case 'pericolo_ambientale_notturno': // Notturno
             title = "Esito Pericolo";
             let skill = 'agilita'; if (ctx.subType === 'presagio_check') skill = 'presagio';
             check = performSkillCheck(skill, effectiveDifficulty); // Usa effectiveDifficulty
             if (check.success) { desc = getRandomText(esitiPericoloAmbientaleEvitato); }
             else { desc = getRandomText(esitiPericoloAmbientaleColpito); player.hp = Math.max(0, player.hp - ctx.damage); cons = `Subisci ${ctx.damage} HP di danno.`; changed = true; }
             break;

        case 'dilemma_morale': // Diurno
             title = "Conseguenze";
             if (choiceKey === 'N') { desc = getRandomText(esitiDilemmaMoraleIgnora); }
             else if (choiceKey === 'I') {
                 check = performSkillCheck('presagio', effectiveDifficulty); // Usa effectiveDifficulty
                 if (check.success) {
                     desc = getRandomText(esitiDilemmaMoraleIndagaOkPositivo);
                     if(Math.random() < 0.5) { player.food += getRandomInt(1,2); cons = "Trovi del cibo."; changed = true; }
                 } else {
                      desc = getRandomText(esitiDilemmaMoraleIndagaOkNegativo);
                      if(Math.random() < 0.5) { const dmg = getRandomInt(1,3); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni ferito (-${dmg} HP).`; changed = true;}
                 }
             }
             break;

         case 'orrore_indicibile': // Solo notturno
              title = "Confronto con l'Ignoto";
              switch(choiceKey) {
                  case 'F': // Fuga (Agilità)
                      check = performSkillCheck('agilita', effectiveDifficulty);
                      if (check.success) { desc = getRandomText(esitiOrroreIndicibileFugaOk); }
                      else { desc = getRandomText(esitiOrroreIndicibileFugaKo); /* Penalità? */ const dmg = ctx.sanityDamage || 1; player.hp = Math.max(0, player.hp - dmg); cons = `Il terrore ti sfianca (-${dmg} HP).`; changed = true; }
                      break;
                  case 'A': // Affronta (Vigore? Presagio?) Usiamo Vigore per resistenza
                      check = performSkillCheck('vigore', effectiveDifficulty + 1); // Affrontare è più difficile
                      if (check.success) { desc = getRandomText(esitiOrroreIndicibileAffrontaOk); }
                      else { desc = getRandomText(esitiOrroreIndicibileAffrontaKo); /* Penalità grave? */ const dmg = (ctx.sanityDamage || 1) * 2; player.hp = Math.max(0, player.hp - dmg); cons = `La tua mente vacilla (-${dmg} HP).`; changed = true; }
                      break;
              }
              break;

        // Caso 'rifugio_scelta' rimosso perché gestito direttamente in handleTileEvent

        default:
            console.warn(`Unhandled event type in handleEventChoice: ${ctx.event}`); desc = "L'esito di questa azione non è chiaro...";
            break;
    }

    if (changed) {
        renderStats();
        if (checkGameOver()) return; // Esce se il giocatore muore dopo l'evento
    }
    // Mostra popup finale dell'evento (solo descrizione ed eventuale check/conseguenza)
    showEventPopup(title, desc, [], check, cons);
}


function checkGameOver(){if(player.hp<=0 && gameActive){showEndGameMessage(false);return true;} return false;}

function movePlayer(dx, dy){
    if(!gameActive||eventScreenActive)return;
    const nX=player.x+dx, nY=player.y+dy;
    if(nX<0||nX>=MAP_WIDTH||nY<0||nY>=MAP_HEIGHT){addMessage("Bloccato.");return;}
    player.x=nX; player.y=nY;

    // Incremento contatore e transizione Giorno -> Notte
    if (isDay) {
        dayNightCounter++;
        //console.log(`Day counter: ${dayNightCounter}/${DAY_LENGTH_MOVES}`); // Debug
        if (dayNightCounter >= DAY_LENGTH_MOVES) {
            isDay = false;
            dayNightCounter = 0; // Resetta per la notte (non usato ma pulito)
            addMessage("[FASE] Il sole tramonta rapidamente. È calata la NOTTE. Cerca un rifugio ('R')!", 'info', true);
            // Forzare render mappa/stats per mostrare cambio fase?
            renderMap(); // Aggiorna mappa (utile se stile cambia di notte)
            renderStats(); // Aggiorna stats (utile se UI indica fase)
        }
    } else {
        // Logica specifica per ogni passo notturno? (es. chance piccola di perdere HP?)
        // Per ora, la notte aumenta solo la difficoltà/frequenza degli eventi in handleTileEvent
    }

    // Rimosso consumo risorse da qui

    const tile=map[player.y]?.[player.x];
    if(!tile) { console.error("Tile non valida a", player.x, player.y); return; }

    const popupHandled = handleTileEvent(tile); // Gestisce eventi, transizione notte->giorno, consumo

    // checkGameOver viene chiamato DENTRO handleTileEvent se necessario (es. dopo consumo/penalità)

    // Render mappa/stats solo se non è stato mostrato un popup dall'evento
    // e se non siamo morti
    if(!popupHandled && gameActive) {
        renderMap();
        renderStats(); // Render stats dopo movimento SE non c'è popup
    }
}

function handleKeyPress(event){
    // Log per vedere se la funzione viene chiamata e quale tasto
    console.log(`[KeyPress] Tasto premuto: ${event.key}, Repeat: ${event.repeat}`);

    // Gestione scelte evento (rimane uguale)
    if (eventScreenActive && !event.repeat && currentEventChoices.length > 0) {
        console.log('[KeyPress] Evento attivo, controllo scelte...');
        const key=event.key.toUpperCase();
        const choice=currentEventChoices.find(c=>c.key===key);
        if (choice) { 
            console.log(`[KeyPress] Scelta valida trovata: ${key}, chiamo handleEventChoice.`);
            event.preventDefault(); // Previene azione default solo se il tasto è una scelta valida
            handleEventChoice(key);
        } else {
            console.log(`[KeyPress] Tasto ${key} non è una scelta valida per l'evento.`);
        }
        // Non fare nulla se il tasto premuto non è una scelta valida nell'evento
        return; 
    } 
    
    // Gestione movimento (fuori da evento)
    if (gameActive && !eventScreenActive && !event.repeat) {
        console.log('[KeyPress] Gioco attivo, nessun evento. Controllo tasti movimento...');
        let dx=0, dy=0;
        let validMoveKey = false;
        const lowerCaseKey = event.key.toLowerCase(); // Usa toLowerCase per gestire Maiusc
        
        switch(lowerCaseKey){ 
             case "arrowup": 
             case "w": 
                dy=-1; 
                validMoveKey = true;
                break;
             case "arrowdown": 
             case "s": 
                dy=1; 
                validMoveKey = true;
                break;
             case "arrowleft": 
             case "a": 
                dx=-1; 
                validMoveKey = true;
                break;
             case "arrowright": 
             case "d": 
                dx=1; 
                validMoveKey = true;
                break;
             default:
                 console.log(`[KeyPress] Tasto ${lowerCaseKey} non è un tasto di movimento valido.`);
                 // Se non è un tasto di movimento, non fare nulla
                 return;
        }
        
        console.log(`[KeyPress] Tasto movimento rilevato: ${lowerCaseKey}, dx=${dx}, dy=${dy}, valid=${validMoveKey}`);

        // Se è stato premuto un tasto di movimento valido
        if (validMoveKey) {
            console.log('[KeyPress] Chiamo movePlayer...');
            event.preventDefault(); // Previene lo scroll della pagina con le frecce
            movePlayer(dx, dy);
        } else {
            console.log('[KeyPress] Tasto movimento non valido (questo non dovrebbe accadere).');
        }
    } else {
        // Log se non entra nel blocco movimento
        if (!gameActive) console.log('[KeyPress] Ignorato, gioco non attivo.');
        if (eventScreenActive) console.log('[KeyPress] Ignorato, evento attivo (ma non scelta valida).');
        if (event.repeat) console.log('[KeyPress] Ignorato, tasto ripetuto.');
    }
    // Se nessuna delle condizioni sopra è vera (es. gioco non attivo, o tasto non valido), non fare nulla
}

function setupInputListeners(){
    console.log("[Setup] Rimuovo vecchio listener keydown (se esiste)...");
    document.removeEventListener('keydown', handleKeyPress); // Rimuove per sicurezza
    console.log("[Setup] Aggiungo nuovo listener keydown...");
    document.addEventListener('keydown', handleKeyPress);
    console.log("[Setup] Listener keydown aggiunto.");
}

// window.onload - Prepara solo l'essenziale per lo splash screen
window.onload = () => {
    mapDisplay.textContent = "Caricamento..."; // Messaggio generico iniziale
    // Non renderizzare stats/messaggi/legenda qui, verranno fatti da proceedToGame
};
    </script>

</body>
</html>